<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Gestion Inventaire</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
    <div th:replace="fragments/navbar :: navbar"></div>

    <div class="container page-section mt-4">
        <!-- Hero -->
        <div class="hero mb-4">
            <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between">
                <div class="mb-3 mb-md-0">
                    <div class="hero-title"><i class="fas fa-gauge-high"></i> Gérez votre inventaire en un coup d’œil</div>
                    <div class="hero-subtitle">Centralisez le suivi du matériel, des employés et des affectations. Visualisations claires, actions rapides, et indicateurs clés pour piloter efficacement.</div>
                    <div class="mt-3 d-flex flex-wrap gap-2" style="gap:10px;">
                        <span class="badge bg-primary-subtle text-primary" style="border:1px solid #c7d2fe; color:#1e40af;"> <i class="fas fa-circle-notch"></i> Temps réel</span>
                        <span class="badge bg-success-subtle text-success" style="border:1px solid #bbf7d0; color:#065f46;"> <i class="fas fa-check-circle"></i> Affectations maîtrisées</span>
                        <span class="badge bg-info-subtle text-info" style="border:1px solid #bae6fd; color:#075985;"> <i class="fas fa-chart-pie"></i> Statistiques lisibles</span>
                    </div>
                </div>
                <div class="quick-actions">
                    <a href="/materiel" class="btn btn-primary me-2"><i class="fas fa-laptop"></i> Matériel</a>
                    <a href="/employes" class="btn btn-success me-2"><i class="fas fa-users"></i> Employés</a>
                    <a href="/affectations" class="btn btn-warning"><i class="fas fa-link"></i> Affectations</a>
                </div>
            </div>
        </div>
        <!-- Messages de succès/erreur -->
        <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
            <span th:text="${success}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <h1 class="mb-4"><i class="fas fa-tachometer-alt"></i> Tableau de bord</h1>
        
        <!-- Cartes de statistiques -->
        <div class="row mt-4">
            <div class="col-md-3 mb-4">
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-laptop"></i></div>
                    <div class="stat-content">
                        <div class="stat-label">Matériel total</div>
                        <div class="stat-value" th:text="${totalMateriel}">0</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #22c55e, #86efac); box-shadow: 0 8px 18px rgba(34,197,94,.25);"><i class="fas fa-check-circle"></i></div>
                    <div class="stat-content">
                        <div class="stat-label">Matériel affecté</div>
                        <div class="stat-value" th:text="${materielAffecte}">0</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #0ea5e9, #22d3ee); box-shadow: 0 8px 18px rgba(14,165,233,.25);"><i class="fas fa-chart-line"></i></div>
                    <div class="stat-content">
                        <div class="stat-label">Taux d'utilisation</div>
                        <div class="stat-value" th:text="${#numbers.formatDecimal(tauxUtilisation, 1, 2)} + '%'">0%</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b, #fde68a); color: #111; box-shadow: 0 8px 18px rgba(245,158,11,.25);"><i class="fas fa-exclamation-triangle"></i></div>
                    <div class="stat-content">
                        <div class="stat-label">En panne</div>
                        <div class="stat-value" th:text="${pannesParCategorie.values()?.![0] ?: 0}">0</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Navigation rapide -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-rocket"></i> Navigation rapide</h5>
                        <div class="d-grid gap-2 d-md-flex">
                            <a href="/materiel" class="btn btn-outline-primary me-2">
                                <i class="fas fa-laptop"></i> Gérer le matériel
                            </a>
                            <a href="/employes" class="btn btn-outline-secondary me-2">
                                <i class="fas fa-users"></i> Gérer les employés
                            </a>
                            <a href="/affectations" class="btn btn-outline-success">
                                <i class="fas fa-link"></i> Gérer les affectations
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistiques détaillées (graphiques) -->
        <div class="row mt-4">
            <div class="col-md-6 mb-4">
                <div class="chart-card">
                    <div class="dashboard-section-title"><i class="fas fa-chart-pie"></i> Matériel par type</div>
                    <div class="row mt-3">
                        <div class="col-7">
                            <canvas id="chartMaterielType" height="200"></canvas>
                        </div>
                        <div class="col-5">
                            <div class="chart-legend" id="legendMaterielType"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="chart-card">
                    <div class="dashboard-section-title"><i class="fas fa-circle-notch"></i> Taux d'utilisation</div>
                    <div class="row mt-3">
                        <div class="col-7">
                            <canvas id="chartUtilisation" height="200"></canvas>
                        </div>
                        <div class="col-5 d-flex align-items-center">
                            <div>
                                <div class="stat-label">Utilisation actuelle</div>
                                <div class="stat-value" th:text="${#numbers.formatDecimal(tauxUtilisation, 1, 2)} + '%'">0%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-12 mb-4">
                <div class="chart-card">
                    <div class="dashboard-section-title"><i class="fas fa-chart-donut"></i> Affectations par service</div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <canvas id="chartAffectationsService" height="200"></canvas>
                        </div>
                        <div class="col-md-6">
                            <div class="chart-legend" id="legendAffectationsService"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script th:inline="javascript">
        // Prepare data from Thymeleaf models
        const materielParType = /*[[${materielParType}]]*/ {};
        const affectationsParService = /*[[${affectationsParService}]]*/ {};
        const tauxUtilisation = /*[[${tauxUtilisation}]]*/ 0;

        // Utility to build legend
        function renderLegend(containerId, labels, colors, values) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';
            labels.forEach((label, i) => {
                const item = document.createElement('div');
                item.className = 'legend-item';
                item.innerHTML = `<span class="legend-swatch" style="background:${colors[i]}"></span>${label} — ${values[i]}`;
                container.appendChild(item);
            });
        }

        // Color palettes
        const palette = ['#6366f1','#06b6d4','#10b981','#f59e0b','#ef4444','#84cc16','#f472b6','#22c55e','#eab308','#0ea5e9'];

        // Materiel par type chart (doughnut)
        (function(){
            const ctx = document.getElementById('chartMaterielType');
            if (!ctx) return;
            const labels = Object.keys(materielParType || {});
            const values = Object.values(materielParType || {});
            const colors = labels.map((_, i) => palette[i % palette.length]);
            new Chart(ctx, {
                type: 'doughnut',
                data: { labels, datasets: [{ data: values, backgroundColor: colors, borderWidth: 0 }] },
                options: { plugins: { legend: { display: false } }, cutout: '60%', responsive: true }
            });
            renderLegend('legendMaterielType', labels, colors, values);
        })();

        // Taux d'utilisation chart (semi-doughnut gauge)
        (function(){
            const ctx = document.getElementById('chartUtilisation');
            if (!ctx) return;
            const value = Math.max(0, Math.min(100, Number(tauxUtilisation || 0)));
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Utilisé', 'Libre'],
                    datasets: [{ data: [value, 100 - value], backgroundColor: ['#22c55e','#e5e7eb'], borderWidth: 0 }]
                },
                options: { rotation: -90, circumference: 180, cutout: '70%', plugins: { legend: { display: false } }, responsive: true }
            });
        })();

        // Affectations par service chart (doughnut)
        (function(){
            const ctx = document.getElementById('chartAffectationsService');
            if (!ctx) return;
            const labels = Object.keys(affectationsParService || {});
            const values = Object.values(affectationsParService || {});
            const colors = labels.map((_, i) => palette[(i+3) % palette.length]);
            new Chart(ctx, {
                type: 'doughnut',
                data: { labels, datasets: [{ data: values, backgroundColor: colors, borderWidth: 0 }] },
                options: { plugins: { legend: { display: false } }, cutout: '60%', responsive: true }
            });
            renderLegend('legendAffectationsService', labels, colors, values);
        })();
    </script>
</body>
</html>
