<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parc informatique</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-laptop-code"></i> Parc informatique
            </a>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Messages -->
        <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
            <span th:text="${success}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <h1 class="mb-4"><i class="fas fa-tachometer-alt"></i> Tableau de bord</h1>
        
        <!-- Initialisation données -->
        <div class="alert alert-warning" th:if="${totalMateriel == 0}">
            <h5><i class="fas fa-database"></i> Base de données vide</h5>
            <p>Cliquez sur le bouton ci-dessous pour charger les données de test :</p>
            <a href="/init" class="btn btn-primary">
                <i class="fas fa-download"></i> Charger les données de test
            </a>
        </div>
        
        <!-- Cartes de statistiques dynamiques -->
        <div class="row mt-4" th:if="${totalMateriel > 0}">
            <div class="col-md-3 mb-4">
                <div class="card stat-card bg-primary fade-in-up">
                    <div class="card-body">
                        <span class="stat-update-indicator" id="lastUpdate1"></span>
                        <h5 class="card-title"><i class="fas fa-laptop"></i> Matériel total</h5>
                        <h2 id="stat-totalMateriel" th:text="${totalMateriel}">0</h2>
                        <small style="opacity: 0.8;">En stock</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="card stat-card bg-success fade-in-up">
                    <div class="card-body">
                        <span class="stat-update-indicator" id="lastUpdate2"></span>
                        <h5 class="card-title"><i class="fas fa-check-circle"></i> Matériel affecté</h5>
                        <h2 id="stat-materielAffecte" th:text="${materielAffecte}">0</h2>
                        <small style="opacity: 0.8;">En utilisation</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="card stat-card bg-info fade-in-up">
                    <div class="card-body">
                        <span class="stat-update-indicator" id="lastUpdate3"></span>
                        <h5 class="card-title"><i class="fas fa-chart-line"></i> Taux d'utilisation</h5>
                        <h2 id="stat-tauxUtilisation" th:text="${#numbers.formatDecimal(tauxUtilisation, 1, 2)} + '%'">0%</h2>
                        <small style="opacity: 0.8;">Efficacité</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="card stat-card bg-warning fade-in-up">
                    <div class="card-body">
                        <span class="stat-update-indicator" id="lastUpdate4"></span>
                        <h5 class="card-title"><i class="fas fa-exclamation-triangle"></i> En panne</h5>
                        <h2 id="stat-materielEnPanne" th:text="${pannesParCategorie.values()?.![0] ?: 0}">0</h2>
                        <small style="opacity: 0.8;">À réparer</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Cartes supplémentaires -->
        <div class="row mt-2" th:if="${totalMateriel > 0}">
            <div class="col-md-3 mb-4">
                <div class="card stat-card bg-secondary fade-in-up">
                    <div class="card-body">
                        <span class="stat-update-indicator" id="lastUpdate5"></span>
                        <h5 class="card-title"><i class="fas fa-users"></i> Total employés</h5>
                        <h2 id="stat-totalEmployes">0</h2>
                        <small style="opacity: 0.8;">Personnel</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="card stat-card bg-success fade-in-up" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    <div class="card-body">
                        <span class="stat-update-indicator" id="lastUpdate6"></span>
                        <h5 class="card-title"><i class="fas fa-user-check"></i> Employés avec matériel</h5>
                        <h2 id="stat-employesAvecMateriel">0</h2>
                        <small style="opacity: 0.8;">Équipés</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="card stat-card bg-primary fade-in-up" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);">
                    <div class="card-body">
                        <span class="stat-update-indicator" id="lastUpdate7"></span>
                        <h5 class="card-title"><i class="fas fa-box-open"></i> Disponible</h5>
                        <h2 id="stat-materielNonAffecte">0</h2>
                        <small style="opacity: 0.8;">Non affecté</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="card stat-card bg-danger fade-in-up">
                    <div class="card-body">
                        <span class="stat-update-indicator" id="lastUpdate8"></span>
                        <h5 class="card-title"><i class="fas fa-tools"></i> En réparation</h5>
                        <h2 id="stat-materielEnReparation">0</h2>
                        <small style="opacity: 0.8;">Maintenance</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Navigation rapide -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-rocket"></i> Navigation rapide</h5>
                        <div class="d-grid gap-2 d-md-flex">
                            <a href="/materiel" class="btn btn-outline-primary me-2">
                                <i class="fas fa-laptop"></i> Gérer le matériel
                            </a>
                            <a href="/employes" class="btn btn-outline-secondary me-2">
                                <i class="fas fa-users"></i> Gérer les employés
                            </a>
                            <a href="/affectations" class="btn btn-outline-success">
                                <i class="fas fa-link"></i> Gérer les affectations
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistiques détaillées dynamiques -->
        <div class="row mt-4" th:if="${totalMateriel > 0}">
            <div class="col-md-6">
                <div class="card chart-container">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-chart-pie"></i> Matériel par type</h5>
                        <div id="chart-materielParType">
                            <div th:each="entry : ${materielParType}" class="mb-3">
                                <div class="d-flex justify-content-between mb-1">
                                    <span><strong th:text="${entry.key}"></strong></span>
                                    <span th:text="${entry.value} + ' unité(s)'"></span>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar" 
                                         th:attr="data-value=${entry.value}, data-total=${totalMateriel}"
                                         th:style="'width: ' + ${entry.value * 100 / totalMateriel} + '%;'"
                                         th:text="${#numbers.formatDecimal(entry.value * 100 / totalMateriel, 1, 2)} + '%'">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card chart-container">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-chart-bar"></i> Affectations par service</h5>
                        <div id="chart-affectationsParService">
                            <div th:each="entry : ${affectationsParService}" class="mb-3">
                                <div class="d-flex justify-content-between mb-1">
                                    <span><strong th:text="${entry.key}"></strong></span>
                                    <span th:text="${entry.value} + ' affectation(s)'"></span>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar bg-success" 
                                         th:attr="data-value=${entry.value}, data-total=${materielAffecte}"
                                         th:style="'width: ' + ${entry.value * 100 / materielAffecte} + '%;'"
                                         th:text="${#numbers.formatDecimal(entry.value * 100 / materielAffecte, 1, 2)} + '%'">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Fonction pour formater les nombres avec animation
        function animateValue(element, start, end, duration = 500) {
            if (start === end) return;
            const range = end - start;
            const increment = end > start ? 1 : -1;
            const stepTime = Math.abs(Math.floor(duration / range));
            let current = start;
            
            const timer = setInterval(() => {
                current += increment;
                if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
                    element.textContent = end;
                    clearInterval(timer);
                } else {
                    element.textContent = current;
                }
            }, stepTime);
        }
        
        // Fonction pour mettre à jour les statistiques
        function updateStatistics() {
            fetch('/api/statistiques')
                .then(response => response.json())
                .then(data => {
                    // Mettre à jour les statistiques principales avec animation
                    const totalMaterielEl = document.getElementById('stat-totalMateriel');
                    const materielAffecteEl = document.getElementById('stat-materielAffecte');
                    const tauxUtilisationEl = document.getElementById('stat-tauxUtilisation');
                    const materielEnPanneEl = document.getElementById('stat-materielEnPanne');
                    
                    if (totalMaterielEl) {
                        const current = parseInt(totalMaterielEl.textContent) || 0;
                        animateValue(totalMaterielEl, current, data.totalMateriel);
                    }
                    
                    if (materielAffecteEl) {
                        const current = parseInt(materielAffecteEl.textContent) || 0;
                        animateValue(materielAffecteEl, current, data.materielAffecte);
                    }
                    
                    if (tauxUtilisationEl) {
                        const current = parseFloat(tauxUtilisationEl.textContent.replace('%', '')) || 0;
                        const target = parseFloat(data.tauxUtilisation.toFixed(2));
                        animateValue(tauxUtilisationEl, Math.round(current), Math.round(target * 100) / 100);
                        setTimeout(() => {
                            tauxUtilisationEl.textContent = target.toFixed(2) + '%';
                        }, 500);
                    }
                    
                    if (materielEnPanneEl) {
                        const current = parseInt(materielEnPanneEl.textContent) || 0;
                        animateValue(materielEnPanneEl, current, data.materielEnPanne);
                    }
                    
                    // Mettre à jour les nouvelles statistiques
                    const totalEmployesEl = document.getElementById('stat-totalEmployes');
                    const employesAvecMaterielEl = document.getElementById('stat-employesAvecMateriel');
                    const materielNonAffecteEl = document.getElementById('stat-materielNonAffecte');
                    const materielEnReparationEl = document.getElementById('stat-materielEnReparation');
                    
                    if (totalEmployesEl) {
                        const current = parseInt(totalEmployesEl.textContent) || 0;
                        animateValue(totalEmployesEl, current, data.totalEmployes);
                    }
                    
                    if (employesAvecMaterielEl) {
                        const current = parseInt(employesAvecMaterielEl.textContent) || 0;
                        animateValue(employesAvecMaterielEl, current, data.employesAvecMateriel);
                    }
                    
                    if (materielNonAffecteEl) {
                        const current = parseInt(materielNonAffecteEl.textContent) || 0;
                        animateValue(materielNonAffecteEl, current, data.materielNonAffecte);
                    }
                    
                    if (materielEnReparationEl) {
                        const current = parseInt(materielEnReparationEl.textContent) || 0;
                        animateValue(materielEnReparationEl, current, data.materielEnReparation);
                    }
                    
                    // Mettre à jour les graphiques
                    updateCharts(data);
                    
                    // Afficher l'heure de mise à jour
                    const now = new Date();
                    const timeString = now.toLocaleTimeString('fr-FR');
                    document.querySelectorAll('.stat-update-indicator').forEach(el => {
                        el.textContent = 'Mis à jour: ' + timeString;
                    });
                })
                .catch(error => {
                    console.error('Erreur lors de la récupération des statistiques:', error);
                });
        }
        
        // Fonction pour mettre à jour les graphiques
        function updateCharts(data) {
            // Mettre à jour le graphique du matériel par type
            const materielParTypeContainer = document.getElementById('chart-materielParType');
            if (materielParTypeContainer && data.materielParType) {
                materielParTypeContainer.innerHTML = '';
                Object.entries(data.materielParType).forEach(([type, count]) => {
                    const percentage = (count / data.totalMateriel * 100).toFixed(2);
                    const div = document.createElement('div');
                    div.className = 'mb-3';
                    div.innerHTML = `
                        <div class="d-flex justify-content-between mb-1">
                            <span><strong>${type}</strong></span>
                            <span>${count} unité(s)</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar" style="width: ${percentage}%;">
                                ${percentage}%
                            </div>
                        </div>
                    `;
                    materielParTypeContainer.appendChild(div);
                });
            }
            
            // Mettre à jour le graphique des affectations par service
            const affectationsParServiceContainer = document.getElementById('chart-affectationsParService');
            if (affectationsParServiceContainer && data.affectationsParService) {
                affectationsParServiceContainer.innerHTML = '';
                const totalAffectations = Object.values(data.affectationsParService).reduce((a, b) => a + b, 0);
                Object.entries(data.affectationsParService).forEach(([service, count]) => {
                    const percentage = totalAffectations > 0 ? (count / totalAffectations * 100).toFixed(2) : 0;
                    const div = document.createElement('div');
                    div.className = 'mb-3';
                    div.innerHTML = `
                        <div class="d-flex justify-content-between mb-1">
                            <span><strong>${service}</strong></span>
                            <span>${count} affectation(s)</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-success" style="width: ${percentage}%;">
                                ${percentage}%
                            </div>
                        </div>
                    `;
                    affectationsParServiceContainer.appendChild(div);
                });
            }
        }
        
        // Mettre à jour les statistiques toutes les 5 secondes
        if (document.getElementById('stat-totalMateriel')) {
            // Première mise à jour après 2 secondes
            setTimeout(updateStatistics, 2000);
            // Ensuite toutes les 5 secondes
            setInterval(updateStatistics, 5000);
        }
    </script>
</body>
</html>
